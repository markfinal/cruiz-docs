# cruiz developer information

## Architecture
The main point to understand about the application architecture is that it is split into two separate parts:

1. The PySide (v6, with a v2 fallback) UI, with absolutely no Conan modules imported

2. The workers, that can import Conan modules

The workers are functions run in separate processes to the UI. This makes use of the multiprocessing package in Python, and uses the spawn start method. This is for three reasons:

1. spawn is the only start method supported on all platforms
2. spawn starts a fresh Python interpreter, so since the UI has no Conan imports, this means each worker starts in a fresh environment for Conan
3. killing processes seems to be more stable than killing threads (at least in Linux)

The ways that Conan can leak into the UI is through the multiprocessing queues, which are used for message passing between the UI and the worker processes. Data is pickled across the queues, and if the worker sends a message containing an instance of a Conan type, Conan is imported via the unpickling on the UI side when the message is received. Effort is made to detect when this occurs. An interop layer exists so that the UI can work on data that has been generated by Conan. This may require further maintenance as Conan is developed, or features of cruiz progress.

## Developing in an IDE
The author has found [vscode](https://code.visualstudio.com/) to be a useful IDE to develop and debug in, with Python, linting, rst, PySide extensions helping.

Debugging can be configured so that you can step right into the conan package to figure things out if necessary. Just add `"justMyCode": false` to `launch.json`.

More details can be found, for example, in the [tutorial](https://code.visualstudio.com/docs/python/python-tutorial).

VisualStudio Code has been configured in the cruiz source workspace to format and lint code automatically.

## Tox
Tox is used to run both flake8 and mypy for linting and static analysis. flake8 plugins are used to cover a number of areas.

Add the necessary tools to your Python 3 virtual environment using `pip install -r requirements_dev.txt`.

Running tox is as simple as
```
tox -e lint
```

## Code format
cruiz uses [black](https://pypi.org/project/black/) as a formatter.
